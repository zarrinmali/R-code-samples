---
title: "Data Task: Barley production"
author: "Zarrin Ali"
output: pdf_document
date: "2025-10-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load pacman 
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, tidyverse, rlist, measurements,
  haven, corrplot, effectsize, emmeans, 
  lmtest, lfe, stargazer
)

# TinyTeX
if (!requireNamespace("tinytex", quietly = TRUE)) install.packages("tinytex")
library(tinytex)

select <- dplyr::select
options(
  readr.show_col_types = FALSE,    
  dplyr.summarise.inform = FALSE
)
```

This script analyzes data on barley production and prices in the US from 1990-2017. It uses a dataset on barley production in bushels by agricultural district, as well as a dataset on mean prices received by farmers per bushel of barley by state. The script includes some data visualizations as well as regressions to explore patterns and relationships in the data.

# Load data

```{r}
# This is the only place that needs to be edited to replicate the analysis.

barley_price <- read_csv("~/Desktop/Data tasks/Barley_price-2.csv")

barley_prod <- read_csv("~/Desktop/Data tasks/Barley_production-2.csv")
```

# Data Exploration

## 1. Histogram

Six histograms of agricultural district barley production, one for each of the years stated. 
```{r}

# Years and corresponding colours
years <- c(1990, 1995, 2000, 2005, 2010, 2015)
colors_yrs <- c("1990" = "red", "1995" = "orange", "2000" = "yellow",
            "2005" = "green", "2010" = "blue", "2015" = "purple")

# Loop through each year and complete operations
for (yr in years) {
  
  # Filter year, scale production, and adjust percentiles
  df_year <- barley_prod %>%
    filter(Year == yr) %>%
    mutate(Value_million = Value / 1e6) %>%
    filter(between(Value_million,
                   quantile(Value_million, 0.01, na.rm = TRUE),
                   quantile(Value_million, 0.99, na.rm = TRUE)))
  
  # Create histogram
  p <- ggplot(df_year, aes(x = Value_million)) +
    geom_histogram(fill = colors_yrs[as.character(yr)], color = "black", bins = 30) +
    labs(
      title = paste("Histogram showing barley production (in millions of bushels),", yr),
      x = "Barley Production (millions of bushels)",
      y = "Count"
    ) +
    theme_minimal(base_size = 14) +
    theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1))
  
  # Save plots 
  ggsave(
    filename = paste0("barley_production_histogram_", yr, ".pdf"),
    plot = p,
    width = 8, height = 6
  )
}
```

## 2. Dataset Cleaning

```{r}

# Collapse to state-year level, sum production, scale to millions
barley_prod_state_yr <- barley_prod %>%
  group_by(State, Year) %>%
  summarise(
    prod_bushels = sum(Value, na.rm = TRUE),
    prod_mil = prod_bushels / 1e6,
    .groups = "drop"
  ) 


# Merge with barley price
barley_merged <- barley_prod_state_yr %>%
  inner_join(barley_price, by = c("State", "Year")) %>%
  rename(price = Value) %>%
  select(State, Year, prod_bushels, prod_mil, price) # only vars to be used later

```


## 3. Time Series Plot

Time series plot showing weighted average barley price from 1990 to 2017
```{r, warning = FALSE}

# Compute weighted average of price over all states for each year
weighted_price <- barley_merged %>%
  group_by(Year) %>%
  summarise(
    weighted_price = weighted.mean(price, w = prod_bushels, na.rm = TRUE),
    num_states = n_distinct(State),
    total_prod = sum(prod_bushels, na.rm = TRUE),
    .groups = "drop"
  )

# Plot weighted average price over time
plot_weighted_price <- ggplot(weighted_price, aes(x = Year, y = weighted_price)) +
  geom_line(color = "darkblue", size = 1) +
  geom_point(color = "darkblue") +
  labs(
    title = "Weighted Average Barley Price (1990â€“2017)",
    x = "Year",
    y = "Weighted Average Price (in $ per bushel)"
  ) +
  coord_cartesian(ylim = c(0, 7), expand = FALSE) +
  theme_minimal(base_size = 14) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1))

print(plot_weighted_price)

# Save plot as pdf
ggsave(
  filename = "weighted_barley_price.pdf",
  plot = plot_weighted_price,
  width = 8, height = 5
)
```

## 4. Summary Table

Summary table showing mean annual state-level production by decade and state
```{r}
# Decade var
barley_merged_decade <- barley_merged %>%
  mutate(decade = case_when(
    Year >= 1990 & Year <= 1999 ~ "1990-1999",
    Year >= 2000 & Year <= 2009 ~ "2000-2009",
    Year >= 2010 & Year <= 2017 ~ "2010-2017"
  ))

# Filter states of interest
states_of_interest <- c("IDAHO", "MINNESOTA", "MONTANA", "NORTH DAKOTA", "WYOMING")
barley_filtered <- barley_merged_decade %>%
  filter(State %in% states_of_interest)

# Mean annual state-level production by decade and state
mean_prod_table <- barley_filtered %>%
  group_by(State, decade) %>%
  summarise(mean_prod_bushels = mean(prod_mil, na.rm = TRUE)) %>%
  ungroup()

# Reshape the table
summary_table <- mean_prod_table %>%
  pivot_wider(names_from = decade, values_from = mean_prod_bushels)


```

```{r, results='asis'}
# stragazer to allow the table to be included in the pdf rendered from this script

stargazer(
  summary_table,
  type = "latex",
  summary = FALSE,
  title = "Mean Annual Barley Production (in millions of bushels) by State and Decade",
  digits = 2,
  rownames = FALSE
)
```

```{r}
# The following steps are done to save the table in a separate pdf

# Generate LaTeX table code
summary_table_latex <- capture.output(
  stargazer(
    summary_table,
    type = "latex",
    summary = FALSE,
    title = "Mean Annual Barley Production (in millions of bushels) by State and Decade",
    digits = 2,
    rownames = FALSE
  )
)

tex_content <- c(
  "\\documentclass{article}",
  "\\usepackage{booktabs}",
  "\\usepackage[margin=1in]{geometry}",
  "\\begin{document}",
  summary_table_latex,
  "\\end{document}"
)

# First save as .tex
writeLines(tex_content, "summary_table.tex")

# Then save as PDF
tinytex::pdflatex("summary_table.tex")

```

# Regressions

```{r}
# Regression of production on price

lm_prod_price <- lm(prod_mil ~ price, data = barley_merged)
summary(lm_prod_price)
```


```{r}
# Regression of production on price with state FEs and SEs clustered at state level

state_fe_model <- felm(prod_mil ~ price | State | 0 | State, data = barley_merged)
summary(state_fe_model)

```

```{r}
# Create demeaned price variable
barley_merged_1 <- barley_merged %>%
  group_by(State) %>%
  mutate(price_demeaned = price - mean(price, na.rm = TRUE)) %>%
  ungroup()

```

```{r}
# Regress price on state FEs
price_fe_model <- felm(price ~ 1 | State, data = barley_merged_1)

# Create residual variable
barley_merged_2 <- barley_merged_1 %>%
  mutate(price_resid = as.vector(resid(price_fe_model)))

# Check that price_demeaned = price_resid
stopifnot(all(abs(barley_merged_2$price_demeaned - barley_merged_2$price_resid) < 1e-8))
```

```{r}
# Regression of production on price_demeaned with no FE and no intercept. SEs clustered at state level.

price_demeaned_model <- felm(prod_mil ~ 0 + price_demeaned | 0 | 0 | State, data = barley_merged_2)
summary(price_demeaned_model)
```

```{r}
# Regression with both state + year FEs
state_yr_fe_model <- felm(prod_mil ~ price | State + Year | 0 | State, data = barley_merged_2)
summary(state_yr_fe_model)
```


## Table summarizing the regression results from above

```{r regression-table, results='asis'}
stargazer(lm_prod_price, state_fe_model, price_demeaned_model, state_yr_fe_model,
          type = "latex",
          title = "Regression Results of Barley Production on Price",
          dep.var.labels = "Production (millions of bushels)",
          covariate.labels = c("Price"),
          se = list(
            sqrt(diag(vcov(lm_prod_price))), # default SE for lm model
            sqrt(diag(vcov(state_fe_model))), # clustered SE for felm models
            sqrt(diag(vcov(price_demeaned_model))),
            sqrt(diag(vcov(state_yr_fe_model)))
          ),
          add.lines = list(
            c("Fixed Effects", "None", "State", "None", "State + Year")
          ),
          digits = 2,
          no.space = TRUE)

```

```{r}
# The following is done to save the table in a separate pdf

reg_table <- capture.output(
  stargazer(lm_prod_price, state_fe_model, price_demeaned_model, state_yr_fe_model,
          type = "latex",
          title = "Regression Results of Barley Production on Price",
          dep.var.labels = "Production (millions of bushels)",
          covariate.labels = c("Price"),
          se = list(
            sqrt(diag(vcov(lm_prod_price))), # default SE for lm model
            sqrt(diag(vcov(state_fe_model))), # clustered SE for felm models
            sqrt(diag(vcov(price_demeaned_model))),
            sqrt(diag(vcov(state_yr_fe_model)))
          ),
          add.lines = list(
            c("Fixed Effects", "None", "State", "None", "State + Year")
          ),
          digits = 2,
          no.space = TRUE)
)

tex_content_reg <- c(
  "\\documentclass{article}",
  "\\usepackage{booktabs}",
  "\\usepackage[margin=1in]{geometry}",
  "\\begin{document}",
  "\\setcounter{table}{1}",
  reg_table,
  "\\end{document}"
)

writeLines(tex_content_reg, "reg_table.tex") 

pdflatex("reg_table.tex")
```


```{r}
# Save the final dataset
write_csv(barley_merged_2, "final_dataset.csv")
```
